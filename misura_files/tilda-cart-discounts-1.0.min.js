function tcart__calcAmountWithDiscounts(){if(window.tcart&&window.tcart.products&&0!==window.tcart.products.length&&window.t_cart__discounts&&Array.isArray(window.t_cart__discounts)&&0!==window.t_cart__discounts.length){var t=[];window.tcart.products.forEach((function(t){delete t.discountid,delete t.amount_withdiscount,delete t.price_withdiscount})),delete window.tcart.dyndiscount,delete window.tcart.prodamount_withdyndiscount,void 0===window.t_cart_sorteddiscounts&&tcart__sortDiscounts(),window.t_cart__discounts.forEach((function(o){var i={};o.typeid>=0&&o.typeid<=3&&(i=o.typeid%2==0?tcart__calcAmountWithLinearDiscount(o):tcart__calcAmountWithDiffDiscount(o)),i.used&&(i.rewrited?t=[o.id]:t.push(o.id))})),tcart__updateCartDataWithDiscount(),tcart__updateCartIconDiscount()}}function tcart__calcAmountWithLinearDiscount(t){var o=tcart__getValidProductsForDiscount(t);if(o){var i=o.products,n=o.amount,d=o.quantity,c=o.lastSingleValidId;if(0===i.length)return{rewrited:!1,used:!1};var r=Array.prototype.map.call(i,(function(t){return t.uid})),u="0"==t.typeid?d:n,e=parseInt(t.rules.minpercent,10),a=parseInt(t.rules.minlimit,10),s=parseInt(t.rules.maxpercent,10),w=parseInt(t.rules.maxlimit,10),_;if(u<a)return{rewrited:!1,used:!1};_=u>=w?s:Math.floor((u-a)*(s-e)/(w-a)+e);var l=t.rules.type;t.discount_amount=1==l?n<_?n:_:1*(n*(_/100)).toFixed(2);var p=!1;if(window.tcart.products&&i.length===window.tcart.products.length){var m=0;if(i.forEach((function(t){m+=t.amount_withdiscount||t.amount})),!(0==l&&m>n*(1-_/100)||1==l&&m>n-_))return{rewrited:!1,used:!1};p=!0}var h=0,f=[];if(i.forEach((function(t){t.discountid&&window.t_cart__discounts.forEach((function(o){o.id==t.discountid&&f.indexOf(1*o.id)<0&&(f.push(1*o.id),h+=o.discount_amount)}))})),t.discount_amount<h)return{rewrited:!1,used:!1};var y=tcart__setDiscountToProducts(r,_,n,p,t),v=y.total,g=y.rewrited,D=y.used;return window.showdiscountdata&&console.log("discountType",l,"\nvalidProductsTotal",n,"\ntotalAmountWithDiscount",v,"\ndiscountInt",_,"\nisDiscountUsed",D,"\nisDiscountRewrited",g),1==l&&n-v-_<0&&D&&c&&tcart__checkRemainder(c,n,v,_),{rewrited:g,used:D}}}function tcart__calcAmountWithDiffDiscount(t){var o=tcart__getValidProductsForDiscount(t);if(o){var i=o.products,n=o.amount,d=o.quantity,c=o.lastSingleValidId;if(0===i.length)return{rewrited:!1,used:!1};var r=Array.prototype.map.call(i,(function(t){return t.uid})),u="3"==t.typeid?n:d,e=0,a=t.rules.diff;if(Object.keys(a).forEach((function(t){parseInt(u,10)>=parseInt(t,10)&&parseInt(a[t],10)>e&&(e=parseInt(a[t],10))})),0===e)return{rewrited:!1,used:!1};var s=t.rules.type;t.discount_amount=1==s?e:1*(n*(e/100)).toFixed(2);var w=!1;if(window.tcart.products&&i.length===window.tcart.products.length){var _=0;if(i.forEach((function(t){_+=t.amount_withdiscount||t.amount})),!(0==s&&_>n*(1-e/100)||1==s&&_>n-e))return{rewrited:!1,used:!1};w=!0}var l=0,p=[];if(i.forEach((function(t){t.discountid&&window.t_cart__discounts.forEach((function(o){o.id==t.discountid&&p.indexOf(1*o.id)<0&&(p.push(1*o.id),l+=o.discount_amount)}))})),t.discount_amount<l)return{rewrited:!1,used:!1};var m=tcart__setDiscountToProducts(r,e,n,w,t),h=m.total,f=m.rewrited,y=m.used;return window.showdiscountdata&&console.log("discountType",s,"\nvalidProductsTotal",n,"\ntotalAmountWithDiscount",h,"\ndiscountInt",e,"\nisDiscountUsed",y,"\nisDiscountRewrited",f),1==s&&n-h-e<0&&y&&c&&tcart__checkRemainder(c,n,h,e),{rewrited:f,used:y}}}function tcart__getValidProductsForDiscount(t){if(void 0===window.tcart.products)return!1;var o=[],i=0,n=0,d="";if(t.rules.uids&&0!==t.rules.uids.length){var c=1*t.applicationid;window.tcart.products.forEach((function(r){if("yes"!==r.deleted&&0!==Object.keys(r).length)switch(c){case 0:(t.rules.uids.indexOf(1*r.uid)>-1||t.rules.uids.indexOf(1*r.gen_uid)>-1)&&(i+=r.amount,n+=r.quantity,1===r.quantity&&(d=r.uid),o.push(r));break;case 2:t.rules.uids.indexOf(1*r.uid)>-1||t.rules.uids.indexOf(1*r.gen_uid)>-1||(i+=r.amount,n+=r.quantity,1===r.quantity&&(d=r.uid),o.push(r));break;case 1:var u=!1;r.part_uids&&r.part_uids.forEach((function(o){t.rules.uids.indexOf(1*o)>-1&&(u=!0)})),u&&(i+=r.amount,n+=r.quantity,1===r.quantity&&(d=r.uid),o.push(r));break;case 3:var u=!1;r.part_uids&&r.part_uids.forEach((function(o){t.rules.uids.indexOf(1*o)>-1&&(u=!0)})),u||(i+=r.amount,n+=r.quantity,1===r.quantity&&(d=r.uid),o.push(r))}}))}else window.tcart.products.forEach((function(t){"yes"!==t.deleted&&0!==Object.keys(t).length&&(i+=t.amount,n+=t.quantity,1===t.quantity&&(d=t.uid),o.push(t))}));return"1"==t.limitid&&n>t.limit&&(o=[]),{products:o,amount:tcart_ceil(i),quantity:n,lastSingleValidId:d}}function tcart__updateCartDataWithDiscount(){if(window.tcart){var t=0,o=0;window.tcart.products.forEach((function(i){"yes"!==i.deleted&&0!==Object.keys(i).length&&(i.amount_withdiscount<0&&(i.amount_withdiscount=0,i.price_withdiscount=0),o+=i.amount,t+=void 0!==i.amount_withdiscount?i.amount_withdiscount:i.amount)})),t=Math.ceil((100*t).toFixed(1));var i=1*(((o=Math.ceil((100*o).toFixed(1)))-t)/100).toFixed(2);t=1*(t/100).toFixed(2),o=1*(o/100).toFixed(2),void 0===window.sumpromowithdiscount||"object"!=typeof window.tcart.promocode&&"object"!=typeof window.t_cart__promocode?(window.tcart.dyndiscount=i,window.tcart.prodamount_withdyndiscount=t):tcart__compareDiscountAndPromocode(i,t,o),window.showdiscountdata&&window.tcart.products.forEach((function(t){if(t.discountid){var o=Array.prototype.find.call(window.t_cart__discounts,(function(o){return o.id===t.discountid})).name;console.log("Product ("+t.name+") \ndiscount - "+o)}})),window.showdiscountdata&&(console.log("productsTotalWithDiscount",t),console.log("productsTotal",o))}}function tcart__updateCartIconDiscount(){if(!window.tcart_fullscreen){var t=document.querySelector(".t706__carticon-text");t&&void 0!==window.tcart.prodamount_withdyndiscount&&(t.innerHTML="= "+tcart__showPrice(window.tcart.prodamount_withdyndiscount,"acceptzero"))}}function tcart__checkRemainder(t,o,i,n){var d=Math.ceil(tcart_ceil(100*(i+n-o).toFixed(3))),c=!1;0!==d&&window.tcart.products.forEach((function(o){if(o.uid===t&&!c){window.showdiscountdata&&console.log("for product "+o.name+"\nwith amount",o.amount_withdiscount),c=!0;var i=1*Math.ceil((100*o.amount_withdiscount).toFixed(1));o.amount_withdiscount=1*((i-d)/100).toFixed(2),window.showdiscountdata&&console.log("new amount will be",o.amount_withdiscount)}}))}function tcart__setDiscountToProducts(t,o,i,n,d){var c=0,r=!1,u=!1,e=d.rules.type,a=!1,s=[];return window.tcart.products.forEach((function(w){if(!a&&t.indexOf(w.uid)>-1&&"yes"!==w.deleted){var _;if(0==e){var l=1-o/100;_=tcart_ceil(w.price*l)}else 1==e&&(_=tcart_ceil(w.price*(1-o/i)));var p=1*(_*w.quantity).toFixed(2);window.showdiscountdata&&console.log(w.name,w.amount,"->",p),w.discountid?(tcart__compareDiscounts(w.discountid,d)||n)&&(s.push(w.discountid),w.discountid=d.id,w.amount_withdiscount=p,w.price_withdiscount=_,r=!0,u=!0):(w.discountid=d.id,w.amount_withdiscount=p,w.price_withdiscount=_,u=!0),w.discountid===d.id||tcart__compareDiscounts(w.discountid,d)||(u=!1,a=!0),c+=w.amount_withdiscount}})),0!==s.length&&tcart__deleteOldDiscounts(s),{total:tcart_ceil(c),rewrited:r,used:u}}function tcart__deleteOldDiscounts(t){window.tcart.products.forEach((function(o){var i=o.discountid;i&&t.indexOf(i)>-1&&(delete o.discountid,delete o.amount_withdiscount,delete o.price_withdiscount)}))}function tcart__compareDiscounts(t,o){if(void 0===t)return!0;var i=Array.prototype.filter.call(window.t_cart__discounts,(function(o){return o.id===t}))[0];return i.discount_amount>=o.discount_amount&&tcart__deleteOldDiscounts([o.id]),i.discount_amount<o.discount_amount}function tcart__compareDiscountAndPromocode(t,o,i){var n,d="object"==typeof window.tcart.promocode?window.tcart.promocode:window.t_cart__promocode,c=!1,r="allow"===window.sumpromowithdiscount?o:i;d.discountsum?n=d.discountsum:d.discountpercent&&(n=1*(r*d.discountpercent*1/100).toFixed(2)),"deny"===window.sumpromowithdiscount&&(n>=t?(delete window.tcart.prodamount_withdyndiscount,delete window.tcart.dyndiscount,window.tcart.products.forEach((function(t){delete t.discountid,delete t.amount_withdiscount})),window.tcart.promocode=d,c=!0):("object"!=typeof window.t_cart__promocode&&(window.t_cart__promocode={},window.t_cart__promocode=Object.assign(window.t_cart__promocode,window.tcart.promocode)),delete window.tcart.promocode,window.tcart.dyndiscount=t,window.tcart.prodamount_withdyndiscount=o)),"allow"===window.sumpromowithdiscount&&(window.tcart.dyndiscount=t,window.tcart.prodamount_withdyndiscount=o,window.tcart.promocode=d);var u=document.querySelector(".t-inputpromocode__wrapper");if(u){var e="";if(e+='<div style="font-weight:600;" class="t-text">',t>0&&"deny"===window.sumpromowithdiscount&&(e+='<div style="margin-bottom: 10px;">',e+=t_input_promocode__getLangText("ownerrestriction"),e+="</div>"),t>0&&(e+=t_input_promocode__getLangText("specialdiscount")+": "+tcart__showPrice(t)),"deny"===window.sumpromowithdiscount&&t>0&&(e+=" ("+t_input_promocode__getLangText(c?"notused":"used")+")"),e+="<br>",e+=t_input_promocode__getLangText("promocodediscount")+" "+d.promocode+": ",d.discountsum&&d.discountsum>0)if("object"==typeof window.tcart)try{"function"==typeof tcart__showPrice&&(e+=tcart__showPrice(d.discountsum))}catch(t){}else e+=d.discountsum;d.discountpercent&&d.discountpercent>0&&(e+=tcart__showPrice(n)),"deny"===window.sumpromowithdiscount&&t>0&&(e+=" ("+t_input_promocode__getLangText(c?"used":"notused")+")"),e+="</div>",u.innerHTML=e}}function tcart__sortDiscounts(){var t=[],o=[],i=[];window.t_cart__discounts.forEach((function(n){n.rules.uids&&n.rules.uids.length>0?0==n.applicationid?i.push(n):t.push(n):o.push(n)})),i=Array.prototype.sort.call(i,(function(t,o){return t.rules.uids.length<o.rules.uids.length?-1:1})),t=Array.prototype.sort.call(t,(function(t,o){return t.rules.uids.length<o.rules.uids.length?-1:1})),i=(i=i.concat(t)).concat(o),window.t_cart_sorteddiscounts=i,window.t_cart__discounts=i}function tcart_ceil(t){return t=(t*=100).toFixed(3),t=Math.ceil(t)/100}